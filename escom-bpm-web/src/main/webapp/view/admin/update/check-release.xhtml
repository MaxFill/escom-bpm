<ui:composition  xmlns="http://www.w3.org/1999/xhtml"
                 xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                 xmlns:p="http://primefaces.org/ui"
                 xmlns:pe="http://primefaces.org/ui/extensions"
                 xmlns:f="http://xmlns.jcp.org/jsf/core"
                 xmlns:h="http://xmlns.jcp.org/jsf/html"
                 template="/view/templ/templ-dlg.xhtml">

    <ui:param name="_bean" value="#{checkReleaseBean}"/>
        
    <ui:define name="systems">
        <script language="javascript" type="text/javascript">
            function init(wsUri) {
                console.log("connect to:" + wsUri);
                websocket = new WebSocket(wsUri);
                websocket.onopen = function (evt) {
                    onOpen(evt)
                };
                websocket.onmessage = function (evt) {
                    onMessage(evt)
                };
                websocket.onerror = function (evt) {
                    onError(evt)

                };
            }

            function onOpen(evt) {
                console.log("CONNECTED");
                document.getElementById('centerFRM:btnRefresh').click();
            }

            function onMessage(evt) {
                console.log("RECEIVED: " + evt.data);
                var json = JSON.parse(evt.data); 
                document.getElementById('centerFRM:actualRelease').value = json.number;
                document.getElementById('centerFRM:pageRelease').value = json.page;
                document.getElementById('centerFRM:dateRelease').value = json.date;
                document.getElementById('centerFRM:versionRelease').value = json.version;
                updateReleaseInfo();
            }

            function onError(evt) {
                console.log('ERROR: ' + evt.data);
                onErrorConnect();
            }

            function doSend(message) {
                console.log("SENT: " + message);
                websocket.send(message);
            }

            window.onbeforeunload = function() {
                websocket.onclose = function () {}; // disable onclose handler first
                websocket.close()
            };
            ///window.addEventListener("load", init, false);
        </script>
    </ui:define>

    <ui:define name="title">
        #{bundle.CheckUpdates}
    </ui:define>

    <ui:define name="menuActions" >
        <p:menuitem icon="ui-icon-arrowrefresh-1-w" value="#{bundle.Refresh}"
                    onclick="document.getElementById('centerFRM:btnRefresh').click();">
        </p:menuitem>
    </ui:define>

    <ui:define name="toolbarComponents" >
        <p:commandButton id="btnRefresh" value="#{bundle.Refresh}" title="#{bundle.CheckUpdates}"
                     onclick="doSend('#{checkReleaseBean.licence.licenceNumber}')"/>
        <p:commandButton value="Test" action="#{checkReleaseBean.test()}" />
    </ui:define>

    <ui:define name="centerFormContent">
        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-6, ui-grid-col-6" styleClass="ui-grid-col-12 without-spaces">
            <p:panelGrid columns="1" layout="grid" columnClasses="ui-grid-col-12 without-spaces" styleClass="ui-grid-col-12 without-spaces">
                <h:panelGroup>
                    <p:outputLabel value="#{bundle.ActualRelease}" />
                    <p:separator/>
                </h:panelGroup>

                <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" styleClass="ui-grid-col-12">
                    <h:outputLabel value="#{bundle.Version}:" />
                    <p:inputText value="#{checkReleaseBean.versionRelease}" readonly="true"/>

                    <h:outputLabel value="#{bundle.Number}:" />
                    <p:inputText value="#{checkReleaseBean.releaseNumber}" readonly="true"/>

                    <h:outputLabel value="#{bundle.Date}:" />
                    <p:inputText value="#{checkReleaseBean.dateRelease}" readonly="true">
                        <f:convertDateTime type="date" dateStyle="short" locale="#{sessionBean.locale}" timeZone="#{TimeZone.getDefault()}"/>
                    </p:inputText>

                    <p:spacer/>
                    <p:commandLink value="#{bundle.GoToSupport}"
                               actionListener="#{checkReleaseBean.onGotoSupportPage}" target="_blank"/>
                </p:panelGrid>
            </p:panelGrid>

            <p:panelGrid columns="1" layout="grid" columnClasses="ui-grid-col-12 col-padding" styleClass="ui-grid-col-12 without-spaces">
                <h:panelGroup>
                    <p:outputLabel value="#{bundle.CurrentRelease}" />
                    <p:separator/>
                </h:panelGroup>

                <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-2, ui-grid-col-10" styleClass="ui-grid-col-12 without-spaces">
                    <h:outputLabel value="#{bundle.Version}:" />
                    <p:inputText value="#{checkReleaseBean.licence.versionNumber}" readonly="true" />

                    <h:outputLabel value="#{bundle.Number}:" />
                    <p:inputText value="#{checkReleaseBean.licence.releaseNumber}" readonly="true" />

                    <h:outputLabel value="#{bundle.Date}:" />
                    <p:inputText value="#{checkReleaseBean.licence.releaseDate}" readonly="true" >
                        <f:convertDateTime type="date" dateStyle="short" locale="#{sessionBean.locale}" timeZone="#{TimeZone.getDefault()}"/>
                    </p:inputText>
                </p:panelGrid>
            </p:panelGrid>
        </p:panelGrid>

        <p:remoteCommand name="updateReleaseInfo" action="#{checkReleaseBean.updateReleaseInfo()}"/>
        <p:remoteCommand name="onErrorConnect" action="#{checkReleaseBean.onErrorConnect()}"/>

        <p:inputText id="dateRelease" value="#{checkReleaseBean.strDateRelease}" style="display: none;"/>
        <p:inputText id="versionRelease" value="#{checkReleaseBean.versionRelease}" style="display: none;"/>
        <p:inputText id="actualRelease" value="#{checkReleaseBean.releaseNumber}" style="display: none;"/>
        <p:inputText id="pageRelease" value="#{checkReleaseBean.pageRelease}" style="display: none;"/>
    </ui:define>
</ui:composition>