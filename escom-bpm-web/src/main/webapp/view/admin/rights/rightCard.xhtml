<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:pe="http://primefaces.org/ui/extensions"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    template="/view/templ/templ.xhtml">  

    <ui:define name="preRendered">
        <f:metadata>
            <f:event type="preRenderView" listener="#{rightCardBean.onOpenCard()}"/>
        </f:metadata>
    </ui:define>

    <ui:define name="title">
        #{bundle.Rights}
    </ui:define>

    <ui:param name="_frm" value="frmRightEdit" />

    <ui:define name="body">
        <script type="text/javascript" >
            var itemChange = 0;
        </script>

        <pe:layout fullPage="true" options="#{rightCardBean.layoutOptions}" widgetVar="fpLayoutWidget">
            <p:ajax event="resize" listener="#{rightCardBean.handleResize}"/> 
            <pe:layoutPane position="center" resizable="true">
                <h:form id="#{_frm}" style="font-size: 90%;">

                    <p:hotkey bind="esc" id="hotskey"
                              immediate="true"                             
                              onstart="document.getElementById('#{_frm}:btnClose').click();"> 
                    </p:hotkey>

                    <p:remoteCommand name="onChangeItem" immediate="true" 
                                     actionListener="#{rightCardBean.onItemChange()}"
                                     oncomplete="return itemChange = 0;">            
                    </p:remoteCommand>

                    <p:menubar styleClass="without-spaces">
                        <p:submenu label="#{bundle.Actions}" icon="ui-icon-gear" styleClass="submenu">
                            <p:menuitem icon="ui-icon-circle-check" value="#{bundle.SaveAndClose}"
                                        onclick="document.getElementById('#{_frm}:btnSave').click();"> 
                            </p:menuitem>
                            <p:separator />
                            <p:menuitem icon="ui-icon-circle-close" value="#{bundle.Close}"
                                        onclick="document.getElementById('#{_frm}:btnClose').click();"> 
                            </p:menuitem>
                        </p:submenu>
                        <f:facet name="options">
 
                            <p:commandButton id="btnSave" value="#{bundle.SaveAndClose}" 
                                             title="#{bundle.SaveAndClose}"
                                             update="#{_frm}"
                                             action="#{rightCardBean.onSaveChangeRight()}"
                                             onclick="if (itemChange == 1)
                                                 onChangeItem();"> 
                            </p:commandButton> 
                            <p:commandButton id="btnClose" icon="ui-icon-circle-close" style="float: right;"
                                             title="#{bundle.Cancel}"
                                             immediate="true"
                                             action="#{rightCardBean.onCancelSave()}"
                                             onclick="if (itemChange == 1)
                                                 onChangeItem();"/>
                        </f:facet>
                    </p:menubar>

                    <p:panelGrid columns="1" layout="grid" columnClasses="ui-grid-col-12 col-padding" styleClass="ui-grid-col-12 col-padding">
                        <p:messages id="messages" showDetail="true" closable="true" styleClass="ui-panelgrid-blank ui-grid-col-12 col-padding">
                            <p:autoUpdate />
                        </p:messages>

                        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-9" styleClass="ui-grid-col-12 col-padding">
                            <h:outputLabel value="#{bundle.Object}:" rendered="#{rightCardBean.selRight.objLink != null}"/>
                            <p:outputLabel value="#{rightCardBean.getObjName(rightCardBean.selRight.objLink)}" rendered="#{rightCardBean.selRight.objLink != null}"/>
                            
                            <h:outputLabel value="#{bundle.ForState}:"/>
                            <p:outputLabel value="#{rightCardBean.stateName}"/>
                           
                            <h:outputLabel value="#{rightCardBean.typeName}:" />
                            <p:outputLabel value="#{rightCardBean.selRight.name}" id="lbRightName"/> 

                        </p:panelGrid>

                        <p:selectOneRadio id="rbRightType" value="#{rightCardBean.selRight.objType}" layout="custom" style="float: right;"
                                          valueChangeListener="#{rightCardBean.onTypeChangeRight}">
                            <f:selectItem itemLabel="#{bundle.ForGroup}" itemValue="0" />
                            <f:selectItem itemLabel="#{bundle.ForUser}"  itemValue="1" />
                            <f:selectItem itemLabel="#{bundle.ForRole}"  itemValue="2" />
                            <p:ajax event="valueChange" update="#{_frm}" oncomplete="itemChange = 1;"/>
                        </p:selectOneRadio>

                        <p:panelGrid columns="3" styleClass="ui-panelgrid-blank">
                            <p:outputLabel value="#{bundle.ForUser}"/>
                            <p:radioButton id="optUser" for="rbRightType" itemIndex="1" />                        
                            <p:selectOneMenu id="selUser" value="#{rightCardBean.selUser}" filter="true" filterMatchMode="startsWith" 
                                             valueChangeListener="#{rightCardBean.onUserChange}" styleClass="ui-grid-col-12"
                                             required="#{rightCardBean.selRight.objType == 1}"
                                             requiredMessage="#{bundle.Field} [#{bundle.ForUser}] #{bundle.MustBeFilled}"
                                             converter="usersConvertor" 
                                             disabled="#{rightCardBean.selRight.objType != 1}">                    
                                <f:selectItems value="#{rightCardBean.users}" var="users" itemLabel="#{users.shortFIO}" itemValue="#{users}"/>
                                <f:selectItem itemValue="#{rightCardBean.selUser}" itemLabel="#{rightCardBean.selUser.shortFIO}" />
                                <p:ajax event="change" update="#{_frm}:lbRightName" oncomplete="itemChange = 1;"/>
                            </p:selectOneMenu>

                            <p:outputLabel value="#{bundle.ForGroup}"/>
                            <p:radioButton id="optGroup" for="rbRightType" itemIndex="0" />
                            <p:selectOneMenu id="selGroup" value="#{rightCardBean.selUsGroup}"  filter="true" filterMatchMode="startsWith"
                                             valueChangeListener="#{rightCardBean.onGroupChange}" styleClass="ui-grid-col-12"
                                             required="#{rightCardBean.selRight.objType == 0}"
                                             requiredMessage="#{bundle.Field} [#{bundle.ForGroup}] #{bundle.MustBeFilled}"
                                             converter="groupsUserConvertor"
                                             disabled="#{rightCardBean.selRight.objType != 0}" >
                                <f:selectItems value="#{rightCardBean.userGroupses}" var="groups" itemLabel="#{groups.name}" itemValue="#{groups}"/>
                                <f:selectItem itemValue="#{rightCardBean.selUsGroup}" itemLabel="#{rightCardBean.selUsGroup.name}" />
                                <p:ajax event="change" update="#{_frm}:lbRightName" oncomplete="itemChange = 1;"/>
                            </p:selectOneMenu>
                            
                            <p:outputLabel value="#{bundle.ForRole}"/>
                            <p:radioButton id="optRole" for="rbRightType" itemIndex="2" />
                            <p:selectOneMenu id="selRole" value="#{rightCardBean.selUsRole}"  filter="true" filterMatchMode="startsWith"
                                             valueChangeListener="#{rightCardBean.onRoleChange}" styleClass="ui-grid-col-12"
                                             converter="groupsUserConvertor"
                                             required="#{rightCardBean.selRight.objType == 2}"
                                             requiredMessage="#{bundle.Field} [#{bundle.ForRole}] #{bundle.MustBeFilled}"
                                             disabled="#{rightCardBean.selRight.objType != 2}" >
                                <f:selectItems value="#{rightCardBean.roles}" var="groups" itemLabel="#{groups.name}" itemValue="#{groups}"/>
                                <f:selectItem itemValue="#{rightCardBean.selUsRole}" itemLabel="#{rightCardBean.selUsRole.name}" />
                                <p:ajax event="change" update="#{_frm}:lbRightName" oncomplete="itemChange = 1;"/>
                            </p:selectOneMenu>
                        </p:panelGrid>

                        <p:separator />

                        <h:panelGrid columns="1">
                            <p:selectBooleanCheckbox id="chBoxAll" itemLabel="#{bundle.All}"
                                                     valueChangeListener="#{rightCardBean.onChangeAllRight}" 
                                                     title="#{bundle.CheckUncheck}">
                                <p:ajax update="chBoxPanel" oncomplete="itemChange = 1;"/>
                            </p:selectBooleanCheckbox>
                        </h:panelGrid>

                        <h:panelGrid id="chBoxPanel" columns="6" >
                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.read}" id="chBoxRead"
                                                     itemLabel="#{bundle.View}" onchange="itemChange = 1;"/>

                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.update}" id="chBoxUpdate"
                                                     itemLabel="#{bundle.Edit}" onchange="itemChange = 1;"/>

                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.create}" id="chBoxCreate"
                                                     itemLabel="#{bundle.Create}" onchange="itemChange = 1;"/>

                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.delete}" id="chBoxDelete"
                                                     itemLabel="#{bundle.Delete}" onchange="itemChange = 1;"/>

                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.changeRight}" id="chBoxRight"
                                                     itemLabel="#{bundle.ChangeRight}" onchange="itemChange = 1;"/>
                            
                            <p:selectBooleanCheckbox value="#{rightCardBean.selRight.addChild}"
                                                     itemLabel="#{bundle.AddChildsRight}" onchange="itemChange = 1;"/>                            
                        </h:panelGrid>
                    </p:panelGrid>

                </h:form>
            </pe:layoutPane>
        </pe:layout>
    </ui:define>
</ui:composition>