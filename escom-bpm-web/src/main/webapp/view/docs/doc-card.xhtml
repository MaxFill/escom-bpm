<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    template="/view/templ/templ-card.xhtml">    

    <ui:param name="_bean" value="#{docCardBean}"/>
    <ui:param name="_item" value="#{_bean.editedItem}"/>
  
    <ui:define name="specActionMenu">
        <p:separator/> 
        <p:menuitem icon="ui-icon-extlink" value="#{bundle.GetURLforView}" title="#{bundle.URLforViewDoc}"
                    rendered="#{_item.id != null}"
                    update="dlgDocUrl:urlPanel"
                    actionListener="#{_bean.onGetDocViewURL(_item)}"
                    oncomplete="PF('urlDlg').show();"/> 
        <p:menuitem icon="ui-icon-extlink" value="#{bundle.GetURLforOpenCard}" title="#{bundle.URLforOpenCardDoc}"
                    rendered="#{_item.id != null}"
                    actionListener="#{_bean.onGetDocOpenURL(_item)}"
                    update="dlgDocUrl:urlPanel"
                    oncomplete="PF('urlDlg').show();"/>                
    </ui:define>
    
    <ui:define name="specSubMenu"> 
        <p:submenu label="#{bundle.Document}" icon="ui-icon-document" styleClass="submenu">
            <p:menuitem icon="ui-icon-arrowthickstop-1-s" value="#{bundle.Download}" title="#{bundle.DownloadCurrentVersion}"
                        disabled="#{_bean.editedItem.attache == null}"
                        actionListener="#{_bean.downloadCurrentVersion()}"/>
            <p:separator/> 
            <p:menuitem icon="ui-icon-clipboard" value="#{bundle.Scaning}" title="#{bundle.Scaning}"        
                        actionListener="#{_bean.onShowScan()}"/> 
            <p:separator/> 
            <p:menuitem icon="ui-icon-link" value="#{bundle.SendToEmailAsLinkPDF}"
                        actionListener="#{_bean.prepareSendMailDoc('asLinkPDF')}"/>
            <p:menuitem icon="ui-icon-link" value="#{bundle.SendToEmailAsLinkCard}"
                        actionListener="#{_bean.prepareSendMailDoc('asLinkCard')}"/>
            <p:menuitem icon="ui-icon-mail-open" value="#{bundle.SendToEmailAsPDF}"
                        actionListener="#{_bean.prepareSendMailDoc('asAttachePDF')}"/>
            <p:menuitem icon="ui-icon-mail-open" value="#{bundle.SendToEmailAsAttache}"
                        actionListener="#{_bean.prepareSendMailDoc('asAttache')}"/>
        </p:submenu>
    </ui:define>

    <ui:define name="card_scripts">
        <p:commandButton id="setLockBtn" actionListener="#{docCardBean.onLockSelectedAttache()}" style="display: none;">
            <p:ajax event="dialogReturn" listener="#{docCardBean.onUpdateSelectedAttache()}" update="#{_frm}:mainTabView:versionsTBL"/>
        </p:commandButton>
    </ui:define>
    
    <ui:define name="page_body">        
        <p:tab title="#{bundle.CardDoc}" id="tabDocCard" >
            <p:panelGrid id="panelDocCard" layout="grid" columns="1" columnClasses="ui-grid-col-12 col-padding" styleClass="without-spaces ui-grid-col-12">
                <p:outputLabel value="#{bundle.Organization}:"/>
                <h:panelGroup id="сompanyPanel" styleClass="ui-grid-col-12">
                    <p:selectOneMenu value="#{_bean.editedItem.company}" id="company" converter="companyConvertor"
                                     title="#{bundle.CompanyDocRegistred}"
                                     disabled="#{_bean.isReadOnly() or _item.number != null}"
                                     styleClass="ui-grid-col-12"
                                     required="#{param['isRequired'] == 'true'}" 
                                     requiredMessage="#{bundle.Field} [#{bundle.Organization}] #{bundle.MustBeFilled}">
                        <f:selectItems value="#{companyBean.findAll()}" var="org" itemLabel="#{org.name}" itemValue="#{org}" />
                        <f:selectItem value="#{null}" itemLabel="#{bundle.EmptySelData}" itemValue="#{null}" itemDisabled="true"/>
                        <p:ajax event="change" update="regNumberPanel" oncomplete="return itemChange = 1;"/>
                    </p:selectOneMenu>
                </h:panelGroup>

                <p:outputLabel value="#{bundle.DocTypes}:" />
                <ui:include src="/view/common/item-select-btn.xhtml" >
                    <ui:param name="_itemValue" value="#{_bean.editedItem.docType}"/>
                    <ui:param name="_required" value="#{true}" />
                    <ui:param name="_disabled" value="#{_bean.isReadOnly() or _item.number != null}"/>
                    <ui:param name="_converter" value="docsTypesConvertor" />
                    <ui:param name="_itemPanel" value="docTypePanel"/>
                    <ui:param name="_titleItem" value="#{bundle.DocTypes}"/>
                    <ui:param name="_selectorBean" value="#{docTypeBean}"/>
                    <ui:param name="_items" value="#{docTypeBean.findAll()}"/>
                    <ui:param name="_actionClear" value="setDocType"/>
                    <ui:param name="_actionSelect" value="onDocTypeSelected"/>
                    <ui:param name="_update" value="#{_frm}:mainTabView:regNumberPanel #{_frm}:mainTabView:docStatusTbl #{_frm}:mainTabView:explToolBar"/>
                </ui:include>

                <p:outputLabel value="#{bundle.Name}:" />
                <p:inputTextarea id="nameDoc" value="#{_bean.editedItem.name}"
                                 title="#{bundle.BriefDescriptionDocument}"
                                 autoResize="false" 
                                 styleClass="ui-grid-col-12"
                                 rows="1"
                                 onkeypress="checkEsc(#{_bean.cancelBtnName});"
                                 disabled="#{_bean.isReadOnly()}"
                                 onchange="return itemChange = 1;"
                                 required="#{param['isRequired'] == 'true'}" 
                                 requiredMessage="#{bundle.Field} [#{bundle.Name}] #{bundle.MustBeFilled}">
                    <f:validateLength maximum="250"  />                        
                </p:inputTextarea>

                <p:outputLabel value="#{bundle.DateDoc}:" /> 
                <h:panelGroup id="datePanel">
                    <p:calendar id="dateDoc" value="#{_bean.editedItem.dateDoc}"  title="#{bundle.DateRegistredDoc}"
                                styleClass="ui-grid-col-12"
                                onkeypress="checkEsc(#{_bean.cancelBtnName});"
                                disabled="#{_bean.isReadOnly() or _item.number != null}"
                                onselect="return itemChange = 1;"
                                required="#{param['isRequired'] == 'true'}" 
                                showButtonPanel="true"
                                pattern="dd.MM.yyyy" mask="99.99.9999"
                                navigator="true" yearRange="c-120:c+20"                                
                                requiredMessage="#{bundle.Field} [#{bundle.DateDoc}] #{bundle.MustBeFilled}">
                    </p:calendar>              
                </h:panelGroup>

                <p:outputLabel value="#{bundle.Number}:" />  
                <h:panelGroup id="regNumberPanel">
                    <h:panelGrid columns="3" style="border-collapse: collapse; border:0px;">
                        <p:inputText value="#{_item.regNumber}" id="number"
                                     title="#{bundle.RegistredDocNumber}"
                                     onkeypress="checkEsc(#{_bean.cancelBtnName});"
                                     disabled="#{_bean.isReadOnly() or _item.number != null}"
                                     onchange="return itemChange = 1;"
                                     requiredMessage="#{bundle.Field} [#{bundle.Number}] #{bundle.MustBeFilled}"> 
                        </p:inputText>
                        <p:commandButton icon="ui-icon-gear" title="#{bundle.Generate}"
                                         disabled="#{_bean.isReadOnly() or _item.docType.numerator.typeCode == null 
                                                     or _item.docType.numerator.typeCode eq 'type.manual'
                                                     or _item.number != null}"
                                         action="#{_bean.onGenerateRegNumber(_item)}"
                                         update="docTypePanel datePanel сompanyPanel regNumberPanel"/>
                        <p:commandButton id="clearNumberBtn"
                                         icon="ui-icon-close" title="#{bundle.UnRegistred}"
                                         update="docTypePanel datePanel сompanyPanel regNumberPanel"
                                         immediate="true"
                                         actionListener="#{_bean.onClearRegNumber(_item)}"
                                         disabled="#{_bean.isReadOnly() or _item.regNumber == null}"/>
                    </h:panelGrid>
                </h:panelGroup>

                <p:outputLabel value="#{bundle.State}:" />
                <p:selectOneMenu value="#{_bean.editedItem.state}" id="state" converter="stateConvertor"                                
                                 disabled="#{_bean.isReadOnly()}"
                                 title="#{bundle.CurrentDocState}"
                                 onchange="return itemChange = 1;"
                                 required="#{param['isRequired'] == 'true'}" 
                                 requiredMessage="#{bundle.Field} [#{bundle.State}] #{bundle.MustBeFilled}">
                    <f:selectItems value="#{stateBean.findAll()}" var="states" itemLabel="#{states.name}" itemValue="#{states}" />
                    <f:selectItem value="#{null}" itemLabel="#{bundle.EmptySelData}" itemValue="#{null}" itemDisabled="true"/>
                </p:selectOneMenu>

                <p:outputLabel value="#{bundle.Partner}:" />
                <ui:include src="/view/common/item-select-btn.xhtml" >
                    <ui:param name="_itemValue" value="#{_bean.editedItem.partner}"/>
                    <ui:param name="_required" value="#{false}" />
                    <ui:param name="_disabled" value="#{_bean.isReadOnly()}"/>
                    <ui:param name="_converter" value="partnersConvertors" />
                    <ui:param name="_itemPanel" value="partnerPanel"/>
                    <ui:param name="_titleItem" value="#{bundle.Partner}"/>
                    <ui:param name="_selectorBean" value="#{partnersBean}"/>
                    <ui:param name="_items" value="#{partnersBean.findAll()}"/>
                    <ui:param name="_actionClear" value="setPartner"/>
                    <ui:param name="_actionSelect" value="onPartnerSelected"/>
                    <ui:param name="_update" value=""/>
                </ui:include>

                <p:outputLabel value="#{bundle.Manager}:" />
                <ui:include src="/view/common/item-select-btn.xhtml" >
                    <ui:param name="_itemValue" value="#{_bean.editedItem.manager}"/>
                    <ui:param name="_required" value="#{false}" />
                    <ui:param name="_disabled" value="#{_bean.isReadOnly()}"/>
                    <ui:param name="_converter" value="staffConvertor" />
                    <ui:param name="_itemPanel" value="managerPanel"/>
                    <ui:param name="_titleItem" value="#{bundle.Manager}"/>
                    <ui:param name="_items" value="#{staffBean.findAll()}"/>
                    <ui:param name="_selectorBean" value="#{staffBean}"/>
                    <ui:param name="_actionClear" value="setManager"/>
                    <ui:param name="_actionSelect" value="onManagerSelected"/>
                    <ui:param name="_update" value=""/>
                </ui:include>
            </p:panelGrid>
        </p:tab> 

        <ui:include src="/view/docs/docStatus/docstatus-list.xhtml"/>
        <ui:include src="/view/docs/attaches/attaches.xhtml"/>
        <ui:include src="/view/docs/doc-places.xhtml"/>

    </ui:define>

    <ui:define name="dialogs">
        <h:form id="dlgDocUrl">
            <p:dialog header="#{bundle.URL}" width="450" height="200" modal="true" closeOnEscape="true" resizable="true" maximizable="true" widgetVar="urlDlg" >
                <p:outputPanel id="urlPanel" styleClass="ui-grid-col-12">
                    <h:panelGroup rendered="#{_item != null}" styleClass="ui-grid-col-12">
                        <p:inputText value="#{_bean.docURL}" styleClass="ui-grid-col-12" 
                                     readonly="true"/>
                    </h:panelGroup>
                </p:outputPanel>
            </p:dialog>
        </h:form>
    </ui:define>

</ui:composition>