<ui:composition  xmlns="http://www.w3.org/1999/xhtml"
                 xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                 xmlns:p="http://primefaces.org/ui"
                 xmlns:f="http://xmlns.jcp.org/jsf/core"
                 xmlns:h="http://xmlns.jcp.org/jsf/html">    

    <p:tab title="#{bundle.Versions}" >                 
        <p:panelGrid columns="1" columnClasses="ui-grid-col-12" styleClass="ui-grid-col-12 col-padding">
            <p:panelGrid columns="1" columnClasses="ui-grid-col-12" styleClass="ui-grid-col-12 col-padding">            
                <p:commandButton icon="ui-icon-clipboard" value="#{bundle.AddVersionFromScan}" id="btnScan" rendered="false"         
                                 actionListener="#{sessionBean.openScaningForm()}">
                    <p:ajax event="dialogReturn" listener="#{docCardBean.addAttacheFromScan}" update="versionsTBL"/>
                </p:commandButton>

                <p:fileUpload id="file" 
                              disabled="#{_bean.isReadOnly()}"
                              allowTypes="#{applicationBean.ALLOW_FILE_TYPES}"
                              sizeLimit="#{docsBean.maxFileSize}"
                              invalidFileMessage = "#{bundle.INVALID_FILE_TYPE}"
                              invalidSizeMessage = "#{bundle.INVALID_FILE_SIZE}"
                              fileLimitMessage   = "#{bundle.INVALID_FILE_COUNT}"
                              process="@this" style="width: 100%;"
                              mode="advanced" auto="true"
                              update="versionsTBL"
                              dragDropSupport="true"
                              label="#{bundle.AddVersionFromFile}" 
                              cancelLabel="#{bundle.Cancel}"
                              uploadLabel="#{bundle.SaveFiles}"
                              fileUploadListener="#{docCardBean.addAttacheFromFile}">                
                </p:fileUpload>            
            </p:panelGrid>

            <p:panelGrid columns="1" columnClasses="ui-grid-col-12" styleClass="ui-grid-col-12 col-padding">
                <p:dataTable id="versionsTBL" value="#{docCardBean.editedItem.attachesList}" 
                             emptyMessage="#{bundle.EmptyTable}"
                             tableStyle="table-layout: auto;" styleClass="ui-grid-col-12 col-padding"
                             paginator="true" paginatorPosition="bottom"                       
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="10,25,50" sortBy="#{attache.number}" sortOrder="descending"
                             rowKey="#{attache.tempId}" selectionMode="single"
                             var="attache" >   

                    <p:column width="20" rendered="#{docCardBean.docIsLock}">                
                        <p:rowToggler rendered="#{attache.lockDate != null}"/>                
                    </p:column>

                    <p:column width="20">
                        <h:graphicImage value="/resources/icon/done.png" title="#{bundle.IsCurrentVersion}"
                                        rendered="#{attache.current}"
                                        styleClass="without-spaces"/>                
                    </p:column>

                    <p:column width="20" headerText="â„–" sortBy="#{attache.number}" >
                        <h:graphicImage value="/resources/icon/doc_lock.png" title="#{bundle.Locked}"
                                        rendered="#{attache.lockDate != null}"/>
                        <h:outputLabel value="#{attache.number}" />
                    </p:column>

                    <p:column headerText="#{bundle.Name}" sortBy="#{attache.name}" >
                        <h:outputLabel value="#{attache.name}" />
                    </p:column>

                    <p:column headerText="#{bundle.Author}" sortBy="#{attache.author.shortFIO}" >
                        <h:outputLabel value="#{attache.author.shortFIO}" />
                    </p:column>   

                    <p:column headerText="#{bundle.DateCreate}" sortBy="#{attache.dateCreate}" >
                        <h:outputLabel value="#{attache.dateCreate}" >
                            <f:convertDateTime pattern="dd.MM.yy : HH.mm"/>
                        </h:outputLabel>
                    </p:column>

                    <p:rowExpansion>
                        <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-2, ui-grid-col-10" styleClass="ui-grid-col-12" >
                            <h:outputLabel value="#{bundle.Editor}"/>
                            <p:outputLabel value="#{attache.lockAuthor.shortFIO}" />

                            <h:outputLabel value="#{bundle.DateLock}" />
                            <p:outputLabel value="#{attache.lockDate}" >
                                <f:convertDateTime pattern="dd.MM.yy : HH.mm"/>
                            </p:outputLabel>

                            <h:outputLabel value="#{bundle.LockedTo}"/>
                            <p:outputLabel value="#{attache.lockDate}" >
                                <f:convertDateTime pattern="dd.MM.yy : HH.mm"/>
                            </p:outputLabel> 
                        </p:panelGrid>
                    </p:rowExpansion>

                    <p:column width="45">                    
                        <p:splitButton  value="#{bundle.View}" title="#{bundle.Commands}" 
                                        actionListener="#{_bean.onViewAttache(attache)}">
                            <p:menuitem icon="ui-icon-pencil" value="#{bundle.EditFile}"
                                        rendered="#{attache.id != null}"
                                        actionListener="#{_bean.onSetSelectedAttache(attache)}"
                                        oncomplete="document.getElementById('#{_frm}:setLockBtn').click();"/>
                            <p:menuitem icon="ui-icon-arrowthickstop-1-s" title="#{bundle.Download}" value="#{bundle.Download}"
                                        ajax="false"
                                        disabled="#{_bean.isReadOnly() or _bean.docIsLock}"
                                        action="#{_bean.attacheDownLoad(attache)}"/>
                            <p:separator />
                            <p:menuitem icon="ui-icon-check" value="#{bundle.MakeMain}" title="#{bundle.MakeMainVersion}"
                                        process="versionsTBL"
                                        disabled="#{_bean.isReadOnly() or _bean.editedItem.mainAttache.equals(attache)}"
                                        update="versionsTBL"
                                        actionListener="#{_bean.makeCurrentVersion(attache)}">
                                <p:confirm header="#{bundle.ChangeVersion}" message="#{bundle.ChangeCurrentVersion}" icon="fa-question-circle" />
                            </p:menuitem> 
                            <p:separator />
                            <p:menuitem icon="ui-icon-trash" value="#{bundle.Delete}"
                                        process="versionsTBL"
                                        disabled="#{_bean.isReadOnly() or _bean.docIsLock}"
                                        update="versionsTBL"
                                        actionListener="#{_bean.deleteAttache(attache)}">
                                <p:confirm header="#{bundle.ConfirmDelete}" message="#{bundle.AreYouSure}" icon="fa-exclamation-circle" />
                            </p:menuitem>
                        </p:splitButton>
                    </p:column>
                </p:dataTable>
            </p:panelGrid>
        </p:panelGrid>
    </p:tab>
</ui:composition>

