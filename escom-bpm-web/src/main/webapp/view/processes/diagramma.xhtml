<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:pe="http://primefaces.org/ui/extensions"
                template="/view/templ/templ-dlg.xhtml"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:param name="_bean" value="#{processBean.diagramBean}"/>

    <ui:define name="customStyleCSS">      
        <h:outputStylesheet library="css" name="processes.css"/>
        <h:outputStylesheet library="contextMenu" name="contextMenu.css"/> 
    </ui:define>

    <ui:define name="customJavaScript">      
        <h:outputScript library="contextMenu" name="contextMenu.js" />        
        <script type="text/javascript">
            function addContextMenu(componentId) {
                var menu = [{
                        name: '#{bundle.Paste}',
                        img: '/escom-bpm-web/resources/icon/paste.png',
                        disable: true,
                        fun: function () {
                            elementPaste();
                        }
                    }, {
                        name: '#{bundle.Close}',
                        img: '/escom-bpm-web/resources/icon/cancel.png'
                    }];

                var component = $(document.getElementById(componentId));
                component.contextMenu('menu', menu, {});
            }

            function addElementMenu(elementIds) {
                var menu = [{
                        name: '#{bundle.Properties}',
                        img: '/escom-bpm-web/resources/images/settings.png',
                        fun: function () {
                            elementOpen();
                        }
                    }, {
                        name: '#{bundle.Copy}',
                        img: '/escom-bpm-web/resources/icon/copy.png',
                        fun: function () {
                            elementCopy();
                        }
                    }, {
                        name: '#{bundle.Delete}',
                        img: '/escom-bpm-web/resources/images/delete.png',
                        fun: function () {
                            elementDelete();
                        }
                    }];

                elementIds.forEach(function (elementId) {
                    var component = $(document.getElementById(elementId));
                    component.contextMenu('menu', menu, {triggerOn: 'contextmenu', displayAround: 'trigger', horAdjust: -component.width() + 20, verAdjust: +20});
                });
            }

            function sendElementClick(info) {
                //console.log("elementId="+info.target.id);                    
                var xPos = info.target.offsetLeft; // / parseFloat($("body").css("font-size"));
                var yPos = info.target.offsetTop; // / parseFloat($("body").css("font-size"));
                var elementId = info.target.id;
                if (elementId.indexOf('diagramm') == -1) {
                    var parentElement = info.target.parentElement;
                    elementId = $(parentElement).attr('id');
                    //console.log("parent elementId="+ elementId);
                    xPos = parentElement.offsetLeft; // / parseFloat($("body").css("font-size"));
                    yPos = parentElement.offsetTop; // / parseFloat($("body").css("font-size"));
                }
                elementClicked([
                    {name: 'elementId', value: elementId},
                    {name: 'posX', value: xPos},
                    {name: 'posY', value: yPos}
                ]);
            }

            $(document).on('click', '.ui-diagram > .ui-diagram-element',
                    function (info) {
                        sendElementClick(info);
                    });

            $(document).on('contextmenu', '.ui-diagram > .ui-diagram-element',
                    function (info) {
                        sendElementClick(info);
                    });

            function refreshContextMenu(componentId) {
                //console.log("refresh componentId="+componentId);
                var menu = [{
                        name: '#{bundle.Paste}',
                        img: '/escom-bpm-web/resources/images/paste.png',
                        disable: false,
                        fun: function () {
                            elementPaste();
                        }
                    }, {
                        name: '#{bundle.Close}',
                        img: '/escom-bpm-web/resources/icon/cancel.png',
                    }];

                var component = $(document.getElementById(componentId));
                component.contextMenu('update', menu, {});
            }
        </script>
    </ui:define>

    <ui:define name="toolbarComponents" > 
        <p:commandButton value="Tasks" title="#{bundle.AddTasks}"
                         disabled="#{_bean.isReadOnly()}"
                         onstart="PF('statusDialog').show()"
                         oncomplete="PF('statusDialog').hide();"
                         actionListener="#{staffBean.onManySelectItem()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onStaffsSelected}" />
        </p:commandButton>
        <p:commandButton  value="And" title="#{bundle.AddLogicElement}"
                          disabled="#{_bean.isReadOnly()}"
                          actionListener="#{_bean.onAddLogicElement('And')}" >
        </p:commandButton>
        <p:commandButton  value="Or" title="#{bundle.AddLogicElement}"
                          disabled="#{_bean.isReadOnly()}"
                          actionListener="#{_bean.onAddLogicElement('Or')}" >
        </p:commandButton>
        <p:commandButton  value="If" title="#{bundle.AddCondition}"
                          disabled="#{_bean.isReadOnly()}"
                          actionListener="#{_bean.onAddConditionElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <p:commandButton  value="Timer" title="#{bundle.AddTimer}"
                          disabled="#{_bean.isReadOnly()}"
                          actionListener="#{_bean.onAddTimerElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <p:commandButton  value="State" title="#{bundle.AddState}"
                          disabled="#{_bean.isReadOnly()}"
                          actionListener="#{_bean.onAddStateElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <p:commandButton value="Message" title="#{bundle.AddMessageElement}"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onAddMessageElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <p:commandButton value="Procedure" title="#{bundle.AddProcedureElement}"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onAddProcElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <p:commandButton value="Start" title="#{bundle.AddStart}"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onAddStartElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>
        <p:commandButton value="Enter" title="#{bundle.AddEnter}"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onAddEnterElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>
        <p:commandButton value="Exit" title="#{bundle.AddExit}"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onAddExitElement()}" >
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}" />
        </p:commandButton>

        <span class="ui-separator">
            <span class="ui-icon ui-icon-grip-dotted-vertical" />
        </span>

        <p:commandButton title="#{bundle.LoadFromTemlate}" icon="ui-icon-folder-open"
                         disabled="#{_bean.isReadOnly()}"                                         
                         onclick="PF('LoadFromTemplDLG').show();"
                         update="LoadFromTemplFRM">                           
        </p:commandButton>
        <p:commandButton title="#{bundle.SaveAsTemlate}" icon="ui-icon-disk"
                         disabled="#{_bean.isReadOnly()}"
                         update="SaveAsTemplFRM"
                         onclick="PF('SaveAsTemplDLG').show();">
        </p:commandButton>
        <span class="ui-separator">
            <span class="ui-icon ui-icon-grip-dotted-vertical" />
        </span>
        <p:commandButton title="Clear" icon="ui-icon-closethick"
                         disabled="#{_bean.isReadOnly()}"
                         actionListener="#{_bean.onClearModel()}"
                         update="southFRM:diagramm">
            <p:confirm header="#{msg.ProcessDiagramWillBeCleared}" message="#{bundle.AreYouSure}" icon="ui-icon-alert"/>
        </p:commandButton>
        <span class="ui-separator">
            <span class="ui-icon ui-icon-grip-dotted-vertical" />
        </span>                          
        <p:commandButton type="button" title="Print" icon="ui-icon-print"/>
    </ui:define>

    <ui:define name="southFormContent">  
        <p:diagram id="diagramm" value="#{_bean.model}" style="height:1600px; width: 1600px;" styleClass="ui-widget-content" var="el" widgetVar="DiagrammWG" >
            <f:facet name="element" >
                <h:outputLabel value="#{_bean.getElementCaption(el)}" styleClass="diagramm-label" style="display:block;margin:0.5em;word-wrap:break-word;"/>
                <p:graphicImage value="#{_bean.getElementImage(el)}" styleClass="diagramm-image"/>
            </f:facet>
            <p:ajax event="connect"    disabled="#{_bean.isReadOnly()}" listener="#{_bean.onConnect}" />
            <p:ajax event="disconnect" disabled="#{_bean.isReadOnly()}" listener="#{_bean.onDisconnect}" />
            <p:ajax event="connectionChange" disabled="#{_bean.isReadOnly()}" listener="#{_bean.onConnectionChange}" />
        </p:diagram>            
        
        
        <p:remoteCommand name="elementClicked" actionListener="#{_bean.onElementClicked}"/>
        <p:remoteCommand name="elementOpen" actionListener="#{_bean.onElementOpenClick()}"/>
        <p:remoteCommand name="elementCopy" actionListener="#{_bean.onElementCopy()}"/>
        <p:remoteCommand name="elementPaste" actionListener="#{_bean.onElementPaste()}"/>
        <p:remoteCommand name="elementDelete" actionListener="#{_bean.onElementDelete}"/>

        <p:commandButton style="display: none;" id="btnOpenElement" actionListener="#{_bean.onElementOpen()}">
            <p:ajax event="dialogReturn" listener="#{_bean.onElementClose}"/>
        </p:commandButton>
        <p:commandButton style="display: none;" id="btnOpenTask" actionListener="#{_bean.onOpenTask()}">
            <p:ajax event="dialogReturn" listener="#{_bean.onAfterTaskClose}"/>
        </p:commandButton>
    </ui:define>

    <ui:define name="dialogs">
        <ui:include src="/view/processes/templ/save-as-dlg.xhtml"/>
        <ui:include src="/view/processes/templ/load-from-templ-dlg.xhtml"/>
    </ui:define>

</ui:composition>