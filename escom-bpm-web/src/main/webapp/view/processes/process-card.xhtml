<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <ui:composition template="/view/templ/templ-card.xhtml"> 

        <ui:param name="_bean" value="#{processCardBean}"/>

        <ui:define name="menuExtReports"> 
            <p:separator />
            <p:menuitem value="#{bundle.ConcorderList}" icon="ui-icon-document"
                        disabled="#{_bean.editedItem.id == null}"
                        actionListener="#{processCardBean.onPreViewListConcorder()}">
            </p:menuitem>
        </ui:define>

        <ui:define name="specActionMenu">
            <p:menuitem icon="ui-icon-play" value="#{bundle.Run}"
                        disabled="#{processCardBean.isReadOnly()}"
                        onclick="document.getElementById('mainFRM:btnRun').click();"/>
            <p:menuitem icon="ui-icon-stop" value="#{bundle.Stop}"
                        disabled="#{processCardBean.isDisableBtnStop()}"
                        onclick="document.getElementById('mainFRM:btnStop').click();"/>
        </ui:define>

        <ui:define name="CardToolButtons">
            <p:commandButton value="#{bundle.Scheme}"
                             disabled="#{processCardBean.isReadOnly() or _bean.editedItem.id == null}"
                             update="mainFRM:mainTabView:concorderList"
                             actionListener="#{processCardBean.onOpenScheme()}" >
                <p:ajax event="dialogReturn" listener="#{_bean.onSchemeClose}" />
            </p:commandButton>                

            <p:spacer width="15"/>
            <h:outputLabel value="#{bundle.State}: "/>
            <p:outputLabel value="#{processCardBean.getLabelFromBundle(_bean.editedItem.state.currentState.name)}"/>
            <p:spacer width="15"/>
            
            <p:menuButton id="btnRun" icon="ui-icon-play" title="#{bundle.StartProcess}" disabled="#{processCardBean.isReadOnly()}">
                <p:menuitem value="#{bundle.SendToAll}" icon="ui-icon-play" update="mainFRM"
                            actionListener="#{processCardBean.onRun()}"
                            oncomplete="return itemChange = 0;">
                    <f:param name="isRequired" value="true"/>
                </p:menuitem>
                <p:menuitem value="#{bundle.SendJustDoNotAgree}" icon="ui-icon-play" update="mainFRM"
                            actionListener="#{processCardBean.onRun()}"
                            oncomplete="return itemChange = 0;">
                    <f:param name="isRequired" value="true"/>
                </p:menuitem>
            </p:menuButton> 
            
            <p:spacer width="2"/>
            <p:commandButton id="btnStop" title="#{bundle.InterruptionProcess}" icon="ui-icon-stop"
                             disabled="#{processCardBean.isDisableBtnStop()}"
                             update="mainFRM" 
                             actionListener="#{processCardBean.onStop()}"
                             oncomplete="return itemChange = 0;">
                <p:confirm header="#{bundle.InterruptionProcess}" message="#{msg.ConfirmInterruptionProcess}" icon="ui-icon-alert" />
            </p:commandButton>
        </ui:define>

        <ui:define name="page_body">                
            <p:tab title="#{bundle.Process}">
                <p:panelGrid columns="1" columnClasses="ui-grid-col-12 col-padding" styleClass="ui-grid-col-12 without-spaces" >                
                    <p:outputLabel value="#{bundle.ProcessCaption}:" indicateRequired="true" />
                    <p:inputText id="nameItem" value="#{processCardBean.editedItem.name}"
                                 styleClass="ui-grid-col-12" 
                                 onkeypress="checkEsc();"
                                 onchange="return itemChange = 1;"
                                 disabled="#{processCardBean.isReadOnly()}"
                                 required="#{param['isRequired'] == 'true'}"
                                 requiredMessage="#{bundle.Field} [#{bundle.ProcessCaption}] #{bundle.MustBeFilled}"/>

                    <p:outputLabel value="#{bundle.Curator}:" indicateRequired="true" />
                    <ui:include src="/view/common/item-select-list-btn.xhtml" >
                        <ui:param name="_itemValue" value="#{_bean.editedItem.curator}"/>
                        <ui:param name="_itemLabel" value="fullName"/>
                        <ui:param name="_required" value="#{true}" />
                        <ui:param name="_disabled" value="#{_bean.isReadOnly()}"/>
                        <ui:param name="_converter" value="staffConvertor" />
                        <ui:param name="_itemPanel" value="curatorPanel"/>
                        <ui:param name="_titleItem" value="#{bundle.Curator}"/>
                        <ui:param name="_selectorBean" value="#{staffBean}"/>
                        <ui:param name="_items" value="#{staffBean.findAll()}"/>
                        <ui:param name="_actionClear" value="setCurator"/>
                        <ui:param name="_actionSelect" value="onChangeCurator"/>
                        <ui:param name="_update" value=""/>
                    </ui:include>

                    <p:outputLabel value="#{bundle.TermApproval}:" indicateRequired="true"/> 
                    <p:calendar id="dtPlanExecDate" value="#{processCardBean.editedItem.planExecDate}"  
                                styleClass="without-spaces" pages="2"
                                timeZone="#{TimeZone.getDefault()}" disabledWeekends="true"
                                showHour="true" showMinute="true" pattern="dd.MM.yyyy HH:mm"
                                disabled="#{processCardBean.isReadOnly()}"
                                locale="#{sessionBean.locale}"
                                required="#{param['isRequired'] == 'true'}"
                                navigator="true" yearRange="c-10:c+20"
                                requiredMessage="#{bundle.Field} [#{bundle.TermApproval}] #{bundle.MustBeFilled}">                    
                        <p:ajax event="dateSelect" onstart="itemChange = 1;" />                    
                    </p:calendar>

                    <p:outputLabel value="#{bundle.DocumentForConcorded}:" indicateRequired="true" />                
                    <ui:include src="/view/common/item-select-btn.xhtml" >
                        <ui:param name="_itemValue" value="#{_bean.editedItem.document}"/>
                        <ui:param name="_itemLabel" value="fullName"/>
                        <ui:param name="_required" value="true" />
                        <ui:param name="_disabled" value="#{_bean.isReadOnly() or _bean.editedItem.id == null}"/>
                        <ui:param name="_itemPanel" value="documentPanel"/>
                        <ui:param name="_titleItem" value="#{bundle.DocumentForConcorded}"/>
                        <ui:param name="_selectorBean" value="#{docBean}"/>
                        <ui:param name="_items" value="#{docBean.findAll()}"/>
                        <ui:param name="_actionClear" value="setDocument"/>
                        <ui:param name="_actionSelect" value="onDocSelected"/>
                        <ui:param name="_validateAction" value="checkDocument"/>                    
                        <ui:param name="_update" value=""/>
                    </ui:include>     

                    <p:outputLabel value="#{bundle.Documents}:" />
                    <ui:include src="/view/docs/doc-list.xhtml" >
                        <ui:param name="_docs" value="#{processCardBean.editedItem.docs}" />
                    </ui:include>                

                    <f:facet name="footer">
                        <p:commandButton id="btnAddFile" style="display: none;"  
                                         actionListener="#{processCardBean.onAddFile()}"
                                         update="mainFRM:mainTabView:tblDocs"> 
                        </p:commandButton>
                        <p:commandButton value="#{bundle.AddDocument}" title="#{bundle.AddExistingDocument}"                                         
                                         rendered="#{!_bean.isReadOnly()}"
                                         actionListener="#{docBean.onManySelectItem()}"> 
                            <p:ajax event="dialogReturn" listener="#{_bean.onDocsSelected}" update="tblDocs"/>
                        </p:commandButton>

                        <p:fileUpload value="#{fileUploadView.file}" auto="true" mode="advanced" styleClass="ui-grid-col-6"
                                      rendered="#{!processCardBean.isReadOnly()}" style="float:right;"
                                      allowTypes="#{applicationBean.ALLOW_FILE_TYPES}"
                                      sizeLimit="#{sessionBean.maxFileSize}"
                                      invalidFileMessage = "#{bundle.INVALID_FILE_TYPE}"
                                      invalidSizeMessage = "#{bundle.INVALID_FILE_SIZE}"
                                      fileLimitMessage   = "#{bundle.INVALID_FILE_COUNT}"
                                      process="@this" dragDropSupport="true"
                                      label="#{bundle.SelectFileAndCreateDoc}" 
                                      cancelLabel="#{bundle.Cancel}"
                                      uploadLabel="#{bundle.SaveFiles}"
                                      fileUploadListener="#{processCardBean.onUploadFile}"                           
                                      onstart="PF('statusDialog').show()"
                                      oncomplete="PF('statusDialog').hide(); document.getElementById('mainFRM:mainTabView:btnAddFile').click();">
                        </p:fileUpload> 
                    </f:facet>
                </p:panelGrid>
            </p:tab>        

            <p:tab title="#{bundle.ApprovalSheet}">
                <p:panelGrid columns="1" layout="grid" columnClasses="ui-grid-col-12 col-padding" styleClass="ui-grid-col-12 without-spaces" > 
                    <p:dataTable id="concorderList" value="#{processCardBean.editedItem.getReports()}" var="report" emptyMessage="#{bundle.EmptyTable}"
                                 rowKey="#{report.tempId}" selectionMode="single" 
                                 paginator="true" paginatorPosition="bottom" 
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"                                                                                  
                                 rowsPerPageTemplate="5, 10, 15, 20, 25, 30, 35" rows="10"
                                 currentPageReportTemplate="#{bundle.CountRecords}: {totalRecords}, #{bundle.Showing} {startRecord}-{endRecord} "
                                 tableStyle="table-layout: auto;" styleClass="ui-grid-col-12 without-spaces">                                         

                        <p:column width="16">
                            <h:graphicImage value="#{processCardBean.getCuratorImage(report.executor)}"/>                     
                        </p:column>

                        <p:column headerText="#{bundle.Employee}" >                        
                            <h:outputText value="#{report.executor.getStaffFIO()}" />                                    
                        </p:column>

                        <p:column headerText="#{bundle.Date}" width="90" >
                            <h:outputLabel value="#{report.dateCreate}">
                                <f:convertDateTime type="both" dateStyle="short" timeStyle="short" locale="#{sessionBean.locale}" timeZone="#{TimeZone.getDefault()}"/>
                            </h:outputLabel>
                        </p:column>

                        <p:column headerText="#{bundle.Status}" >
                            <h:outputLabel value="#{processCardBean.getLabelFromBundle(report.status)}"/>
                        </p:column>

                        <p:column headerText="#{bundle.VersionDoc}" >
                            <h:outputText value="#{report.version.number}" />                                    
                        </p:column>

                    </p:dataTable>                        
                </p:panelGrid>
            </p:tab>        

        </ui:define>           

        <ui:define name="dialogs">
            <ui:include src="/view/tasks/report.xhtml"/>
        </ui:define>
    </ui:composition>
</html>